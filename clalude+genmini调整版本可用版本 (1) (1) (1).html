<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨ - v3.7 æœ€ç»ˆä¿®æ­£ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* === 1. å®Œç¾è¿˜åŸé«˜ç«¯ç‰ˆ UI === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 32px; margin-bottom: 8px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .content { padding: 30px; }
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="file"] {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s;
        }
        input:focus { outline: none; border-color: #667eea; }
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-right: 10px; margin-bottom: 10px;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-warning { background: #ffc107; color: #333; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .status { padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hidden { display: none !important; }
        .progress-container { margin-top: 20px; }
        .progress-bar {
            width: 100%; height: 35px; background: #e0e0e0; border-radius: 18px; overflow: hidden; position: relative;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold;
        }
        .log {
            margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8;
        }
        .log-item { margin-bottom: 5px; padding: 8px; border-left: 3px solid #667eea; padding-left: 12px; background: white; border-radius: 4px; }
        .feature-box { background: #fff9e6; border: 2px dashed #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .feature-box h4 { color: #856404; margin-bottom: 10px; font-size: 16px; }
        .feature-box ul { list-style: none; padding-left: 0; }
        .feature-box li { padding: 5px 0; color: #856404; font-size: 14px; }
        .feature-box li:before { content: "âœ“ "; color: #28a745; font-weight: bold; margin-right: 5px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainPage">
            <div class="header">
                <h1>ğŸ¨ å°çº¢ä¹¦æ–‡æ¡ˆç”Ÿæˆå™¨</h1>
                <p>v3.7 æœ€ç»ˆä¿®æ­£ç‰ˆ - å¹³æ—¶èŠå¤© | 10ä¸ªè¯é¢˜ | é›¶é‡å¤</p>
            </div>
            
            <div class="content">
                <div class="section" id="activationSection">
                    <div class="section-title">ğŸ”‘ è½¯ä»¶æ¿€æ´»</div>
                    <div class="form-group">
                        <label>æ¿€æ´»ç </label>
                        <input type="text" id="activationCode" placeholder="XHS-PREMIUM-20261231">
                    </div>
                    <button class="btn btn-primary" onclick="activate()">æ¿€æ´»è½¯ä»¶</button>
                    <div class="status hidden" id="activationStatus"></div>
                </div>
                
                <div class="section hidden" id="activatedInfo">
                    <div class="section-title">âœ… å·²æ¿€æ´»</div>
                    <p>ç‰ˆæœ¬: <strong><span id="businessInfo"></span></strong></p>
                    <p>çŠ¶æ€: <strong><span id="expireInfo"></span></strong></p>
                    <button class="btn btn-secondary" onclick="resetActivation()">é‡æ–°æ¿€æ´»</button>
                </div>

                <div class="section hidden" id="assignSection">
                    <div class="section-title">ğŸ” æ­¥éª¤1ï¼šæ™ºèƒ½åˆ†é…é€‰é¢˜</div>
                    <div class="feature-box">
                        <h4>ğŸ’¡ æµç¨‹è¯´æ˜</h4>
                        <ul>
                            <li><strong>æ­¥éª¤1ï¼š</strong> ä¸‹è½½ç©ºç™½æ¨¡æ¿ â†’ å¡«å†™æ ‡é¢˜ â†’ ä¸Šä¼ åˆ†é…</li>
                            <li><strong>æ­¥éª¤2ï¼š</strong> ä¸Šä¼ åˆ†é…ç»“æœ â†’ æ™ºèƒ½ç”Ÿæˆ â†’ å¯¼å‡ºï¼ˆå«10ä¸ªè¯é¢˜ï¼‰</li>
                        </ul>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="downloadBlankTemplate()">ğŸ“¥ 1. ä¸‹è½½ç©ºç™½æ¨¡æ¿</button>
                        <button class="btn btn-warning" onclick="document.getElementById('assignFile').click()">ğŸ“¤ 2. æ™ºèƒ½åˆ†é…é€‰é¢˜</button>
                    </div>
                    <input type="file" id="assignFile" accept=".xlsx,.xls" style="display:none" onchange="handleAssignFile()">
                    <div class="status hidden" id="assignFileInfo"></div>
                    <div class="hidden" id="assignProgress">
                        <div class="progress-container">
                            <div class="progress-bar"><div class="progress-fill" id="assignProgressFill">0%</div></div>
                            <div class="log" id="assignLog"></div>
                        </div>
                    </div>
                </div>
                
                <div class="section hidden" id="generateSection">
                    <div class="section-title">ğŸ“ æ­¥éª¤2ï¼šæ‰¹é‡ç”Ÿæˆ (å®‰å…¨é˜²é‡æ¨¡å¼)</div>
                    <div class="form-group">
                        <label>ä¸Šä¼ å·²åˆ†é…çš„Excelæ–‡ä»¶</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect()">
                        <div class="status hidden" id="fileInfo"></div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="generateBtn" onclick="startGeneration()" disabled>ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                        <button class="btn btn-warning hidden" id="pauseBtn" onclick="pauseGeneration()">â¸ï¸ æš‚åœ</button>
                        <button class="btn btn-secondary hidden" id="resumeBtn" onclick="resumeGeneration()">â–¶ï¸ ç»§ç»­</button>
                    </div>
                    <div class="progress-container hidden" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div class="log" id="log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. æ ¸å¿ƒå†…å®¹åº“ (æ•æ„Ÿè¯å·²æ‰‹å·¥ä¿®æ­£) ===
        const CONTENT_LIBRARY = {
            'work': [
                { intro: "å·¥åšå‡ å¹´åæˆ‘å‘ç°ï¼Œé‚£äº›å‡èŒå¿«çš„äººï¼Œéƒ½æœ‰ä¸€ä¸ªè¢«å¿½ç•¥çš„èƒ½åŠ›ï¼šä¼šè¯´åœºé¢è¯ã€‚", points: ["[ä¸€R] ä¼šå¤¸äººï¼Œä½†å¤¸å¾—å…·ä½“\nä¸è¯´é¢†å¯¼æ‚¨çœŸå‰å®³ï¼Œè€Œæ˜¯è¯´è¿™ä¸ªç­–ç•¥çš„XXç‚¹ç‰¹åˆ«å·§å¦™ã€‚", "[äºŒR] ä¼šæ‹’ç»ï¼Œä½†ç»™å°é˜¶\nä¸è¯´æˆ‘ä¸æƒ³åšï¼Œè€Œæ˜¯è¯´è¿™ä¸ªç¡®å®é‡è¦ï¼Œä½†æˆ‘æ‰‹ä¸Šæœ‰XXè¦èµ¶ã€‚", "[ä¸‰R] ä¼šè¡¨æ€ï¼Œä½†ç•™ä½™åœ°\nä¸è¯´æˆ‘å®Œå…¨åŒæ„ï¼Œè€Œæ˜¯è¯´è¿™ä¸ªæ€è·¯ä¸é”™ï¼Œå¦‚æœå†è€ƒè™‘XXä¼šæ›´å®Œå–„ã€‚"] },
                { intro: "æˆ‘æœ‰ä¸ªæœ‹å‹ï¼Œæ€§æ ¼ä¸ç®—å¥½ï¼Œèƒ½åŠ›ä¹Ÿä¸€èˆ¬ï¼Œä½†å‡èŒæ¯”è°éƒ½å¿«ã€‚ä»–åªåšå¯¹äº†ä¸€ä»¶äº‹ï¼šä¼šå‘ä¸Šç®¡ç†ã€‚", points: ["1ã€ä»–ä¼šä¸»åŠ¨æ±‡æŠ¥å·¥åš\nä¸ç­‰é¢†å¯¼é—®ï¼Œå°±å®šæœŸæ€»ç»“è¿›åº¦ã€‚è®©é¢†å¯¼éšæ—¶çŸ¥é“ä»–åœ¨åšä»€ä¹ˆã€‚", "2ã€ä»–ä¼šæ¢ä½æ€è€ƒ\nææ–¹æ¡ˆå‰ï¼Œå…ˆæƒ³é¢†å¯¼å…³å¿ƒä»€ä¹ˆï¼šæ˜¯æˆæœ¬ã€æ•ˆç‡è¿˜æ˜¯é£é™©ï¼Ÿ", "3ã€ä»–ä¼šæ‰¿æ‹…è´£ä»»\nå‡ºé—®é¢˜æ—¶ï¼Œä¸æ¨å¸ä¸æŠ±æ€¨ï¼Œå…ˆè§£å†³é—®é¢˜å†å¤ç›˜ã€‚"] },
                { intro: "å€¼åœºä¸­æœ€éš¾çš„ä¸æ˜¯åšäº‹ï¼Œè€Œæ˜¯åšäººã€‚èƒ½åŠ›èƒ½è®©ä½ è¿›é–€ï¼Œä½†æƒ…å•†å†³å®šä½ èƒ½èµ°å¤šè¿œã€‚", points: ["[ä¸€R] ä¼šå¤¸äººï¼Œä½†ä¸æ‹é©¬å±\nå…·ä½“çš„å¤¸å¥–ï¼Œè®©äººè§‰å¾—ä½ æ˜¯çœŸå¿ƒçš„ï¼Œä¸æ˜¯æ•·è¡ã€‚", "[äºŒR] ä¼šæ‹’ç»ï¼Œä½†ä¸å¾—ç½ªäºº\nç»™ç†ç”±ï¼Œä¸æ˜¯æ‰¾å€Ÿå£ã€‚è®©å¯¹æ–¹è§‰å¾—ä½ çœŸçš„æœ‰è‹¦è¡·ã€‚", "[ä¸‰R] ä¼šé‚¦å¿™ï¼Œä½†ä¸å½“è€å¥½äºº\né‚¦å¿™å¯ä»¥ï¼Œä½†è¦æœ‰è¾¹ç•Œã€‚ä¸æ˜¯æ‰€æœ‰é‚¦åŠ©éƒ½è¦ç­”åº”ã€‚"] },
                { intro: "æ¯•ä¸šä¸‰å¹´ï¼Œæˆ‘æ¢äº†ä¸‰ä»½å·¥åšï¼Œæ¯æ¬¡ç¦»èŒåŸå› éƒ½ä¸€æ ·ï¼šåŒå£«å…³ç³»å¤„ä¸å¥½ã€‚", points: ["1ã€ç¬¬ä¸€ä»½å·¥åšï¼šå¤ªç›´\né¢†å¯¼è¯´ä¸ªæƒ³æ³•ï¼Œæˆ‘ç›´æ¥è¯´è¿™ä¸è¡Œã€‚åæ¥æ‰çŸ¥é“è¦å…ˆè‚¯å®šå†å»ºè®®ã€‚", "2ã€ç¬¬äºŒä»½å·¥åšï¼šå¤ªè¢«åŠ¨\nä»ä¸ä¸»åŠ¨å’ŒåŒå£«èŠå¤©ã€‚åæ¥æ˜ç™½ï¼Œä¸»åŠ¨æ˜¯å»ºç«‹å…³ç³»çš„ç¬¬ä¸€æ­¥ã€‚", "3ã€ç¬¬ä¸‰ä»½å·¥åšï¼šæ‰¾åˆ°å¹³è¡¡\nå¼€å§‹è§‚å¯Ÿé‚£äº›å—æ¬¢è¿çš„åŒå£«æ€ä¹ˆåšï¼Œæ…¢æ…¢å­¦ï¼Œæ…¢æ…¢æ”¹ã€‚"] },
                { intro: "å¦‚ä½•åœ¨å€¼åœºå»ºç«‹å¥½äººç¼˜ï¼Ÿè¿™ä¸‰ä¸ªå°ä¹ æƒ¯ï¼Œè®©åŒå£«éƒ½å–œæ¬¢ä½ ã€‚", points: ["[ä¸€R] ä¸»åŠ¨åˆ†äº«èµ„æº\nçœ‹åˆ°æœ‰ç”¨çš„æ–‡ç« ã€å·¥å…·ï¼Œè½¬å‘ç»™éœ€è¦çš„åŒå£«ã€‚", "[äºŒR] è®°ä½é‡è¦æ—¥å­\nåŒå£«ç”Ÿæ—¥ã€å…¥èŒçºªå¿µæ—¥ï¼Œå‘ä¸ªç¥ç¦ã€‚ç»†èŠ‚æœ€æ‰“åŠ¨äººã€‚", "[ä¸‰R] é€‚åº¦å¯»æ±‚å¸®åŠ©\nä¸è¦ä»€ä¹ˆéƒ½è‡ªå·±æ‰›ã€‚æ±‚åŠ©æ˜¯å»ºç«‹å…³ç³»çš„å¥½æ–¹å¼ã€‚"] },
                { intro: "å€¼åœºé‡Œæœ‰å¥è¯ï¼šåšäº‹è¦åšåˆ°80åˆ†ï¼Œåšäººè¦åšåˆ°120åˆ†ã€‚", points: ["[ä¸€R] åŠŸåŠ³è¦åˆ†äº«\né¡¹ç›®æˆåŠŸäº†ï¼Œå¤šæææ”¯æŒä½ çš„åŒå£«ã€‚", "[äºŒR] é—®é¢˜è¦æ‰¿æ‹…\nå‡ºäº†å·®é”™ï¼Œä¸è¦æ€¥ç€ç”©é”…ã€‚æ‰¿æ‹…è´£ä»»çš„äººæ‰å€¼å¾—ä¿¡ä»»ã€‚", "[ä¸‰R] è¯·æ±‚è¦è¯šæ³\néœ€è¦é‚¦å¿™æ—¶ï¼Œæ€åº¦è¦å¥½ï¼Œè®©å¯¹æ–¹ä¸å¥½æ„æ€æ‹’ç»ã€‚"] }
            ],
            'chat': [
                { intro: "ç¤¾äº¤ä¸­æœ€å°´å°¬çš„æ—¶åˆ»ï¼šä¸çŸ¥é“æ€ä¹ˆæ¥è¯ï¼Œåªèƒ½å¹²ç¬‘ã€‚å…¶å®ï¼Œæ¥è¯æ˜¯æœ‰å…¬å¼çš„ã€‚", points: ["[ä¸€R] è‚¯å®š+å»¶ä¼¸\nä¸è¦åªè¯´å“¦ï¼Œè€Œæ˜¯è¯´ï¼šæŒºå¥½çš„ï¼Œå…·ä½“æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ", "[äºŒR] å…±é¸£+ç»å†\nå¯¹æ–¹è¯´ç´¯ï¼Œä½ è¯´æˆ‘æ‡‚ï¼Œæˆ‘ä¹‹å‰ä¹Ÿç»å†è¿‡...", "[ä¸‰R] å¥½å¥‡+è¿½é—®\nçœŸè¯šçš„å¥½å¥‡ï¼Œèƒ½è®©å¯¹è¯è‡ªç„¶å»¶ç»­ä¸‹å»ã€‚"] },
                { intro: "å¹³æ—¶èŠå¤©ï¼Œæ€ä¹ˆæ‰èƒ½ä¸æŠŠå¤©èŠæ­»ï¼Ÿè¿™ä¸‰ä¸ªæ–¹å¼ç‰¹åˆ«ç®¡ç”¨ã€‚", points: ["[ä¸€R] ä¸è¦åªå›å—¯ã€å“¦ã€å¥½çš„\nå¤šè¯´å‡ ä¸ªå­—ï¼Œè¯é¢˜æ‰èƒ½ç»§ç»­ã€‚", "[äºŒR] å­¦ä¼šç”¨è¡¨æƒ…åŒ…\nå•çº¯çš„æ–‡å­—å®¹æ˜“å†·æ¼ ï¼ŒåŠ ä¸ªè¡¨æƒ…åŒ…æ°”æ°›å°±å˜äº†ã€‚", "[ä¸‰R] é€‚å½“åˆ†äº«è‡ªå·±çš„äº‹\nä¸è¦æ€»æ˜¯è¿½é—®ï¼Œä¹Ÿè¦è¯´è¯´è‡ªå·±ï¼Œè®©å¯¹æ–¹æ„Ÿè§‰æ˜¯èŠå¤©ä¸æ˜¯å®¡é—®ã€‚"] },
                { intro: "å¦‚ä½•å¿«é€Ÿå’Œé™Œç”Ÿäººç ´å†°ï¼Ÿè¯•è¯•è¿™ä¸‰ä¸ªè¯é¢˜ï¼Œç™¾è¯•ç™¾çµã€‚", points: ["[ä¸€R] ä»ç¯å¢ƒå…¥æ‰‹\nä»Šå¤©å¤©æ°”ã€æ´»åŠ¨åœºåœ°ï¼Œéƒ½æ˜¯ç°æˆçš„è¯é¢˜ã€‚", "[äºŒR] ä»å¯¹æ–¹å…¥æ‰‹\nå¤¸å¤¸å¯¹æ–¹çš„é…é¥°ã€è¡£ç€ï¼Œæ²¡äººä¸å–œæ¬¢èµç¾ã€‚", "[ä¸‰R] ä»å…±åŒç‚¹å…¥æ‰‹\nè€ä¹¡ã€æ ¡å‹ã€åŒè¡Œï¼Œæ‰¾åˆ°å…±åŒç‚¹è·ç¦»ä¸€ä¸‹å°±è¿‘äº†ã€‚"] },
                { intro: "å¾ˆå¤šäººè§‰å¾—small talkç—›è‹¦ï¼Œå…¶å®æ˜¯å› ä¸ºæ²¡æ‰¾åˆ°æŠ€å·§ã€‚å¥½å¥‡å¿ƒæ˜¯ç¤¾äº¤çš„å¼€å…³ã€‚", points: ["[ä¸€R] æŠŠè¯„ä»·æ¢æˆè§‚å¯Ÿ\nåˆ«æ€¥ç€ä¸‹å®šä¹‰ï¼Œå¤šè§‚å¯Ÿå¯¹æ–¹çš„å–œå¥½ã€‚", "[äºŒR] å‡è£…è‡ªå·±æ˜¯è®°è€…\næŠŠèŠå¤©å½“æˆé‡‡è®¿ï¼ŒæŒ–æ˜å¯¹æ–¹çš„æ•…äº‹ã€‚", "[ä¸‰R] æ‰¾å…±é€šç‚¹\nä¸éœ€è¦è§‚ç‚¹ä¸€è‡´ï¼Œç†è§£å¯¹æ–¹ä¸ºä»€ä¹ˆè¿™ä¹ˆæƒ³æ›´æœ‰è¶£ã€‚"] },
                { intro: "èŠå¤©æ€»æ˜¯å†·åœºï¼Ÿå¯èƒ½æ˜¯ä½ æ²¡æ³¨æ„è¿™ä¸‰ä¸ªç»†èŠ‚ã€‚", points: ["[ä¸€R] ä¸è¦åªç”¨å°é—­å¼å›ç­”\nå¤šç”¨å¼€æ”¾å¼é—®é¢˜ï¼Œç»™å¯¹æ–¹å‘æŒ¥çš„ç©ºé—´ã€‚", "[äºŒR] ä¸è¦åªè°ˆè‡ªå·±\nå­¦ä¼šå€¾å¬ï¼Œå†æ‰¾åˆ‡å…¥ç‚¹ã€‚", "[ä¸‰R] ä¸è¦å¤ªå¿«ä¸‹åˆ¤æ–­\nå…ˆå¬å®Œï¼Œç†è§£å¯¹æ–¹çš„é€»è¾‘å†è¡¨è¾¾ã€‚"] },
                { intro: "ä¸ºä»€ä¹ˆæœ‰äº›äººè¯´è¯æ€»èƒ½è®©äººèˆ’æœï¼Ÿå› ä¸ºæ‡‚å¾—è¿™3ä¸ªåº•å±‚é€»è¾‘ã€‚", points: ["[ä¸€R] å…ˆå¬å†è¯´\nä¸æŠ¢è¯ï¼Œå¬æ‡‚äº†å†å›åº”ã€‚", "[äºŒR] è‚¯å®š+å»ºè®®\nä¸ç›´æ¥å¦å®šï¼Œå…ˆè‚¯å®šå¯¹æ–¹çš„å¯å–ä¹‹å¤„ã€‚", "[ä¸‰R] è®°ä½ç»†èŠ‚\nè®°ä½å¯¹æ–¹è¯´è¿‡çš„å°äº‹ï¼Œä¸‹æ¬¡æèµ·æ¥ï¼Œå¯¹æ–¹ä¼šå¾ˆæ„ŸåŠ¨ã€‚"] }
            ],
            'dinner': [
                { intro: "èšé¤é¥­å±€ï¼Œæ€ä¹ˆæ‰èƒ½ä¸å°´å°¬ï¼Ÿè®°ä½è¿™ä¸‰ä¸ªè¦ç‚¹å°±å¤Ÿäº†ã€‚", points: ["[ä¸€R] åº§ä½æœ‰è®²ç©¶\nä¸æ‡‚è§„çŸ©åˆ«ä¹±åï¼Œçœ‹é•¿è¾ˆé¢†å¯¼åå“ªå†å†³å®šã€‚", "[äºŒR] æ•¬é…’æœ‰é¡ºåº\nå…ˆæ•¬é•¿è¾ˆï¼Œå†æ•¬å¹³è¾ˆã€‚æ¯å­è¦ä½ä¸€ç‚¹è¡¨ç¤ºå°Šé‡ã€‚", "[ä¸‰R] è¯é¢˜è¦å¾—ä½“\nèŠå·¥åšã€èŠå…´è¶£éƒ½è¡Œï¼Œåˆ«èŠå·¥èµ„å’Œéšç§ã€‚"] },
                { intro: "èšä¼šæ€»æ˜¯æ’ä¸ä¸Šè¯ï¼Ÿå¯èƒ½æ˜¯ä½ çš„è¯é¢˜é€‰æ‹©æœ‰é—®é¢˜ã€‚", points: ["[ä¸€R] é¿å¼€å¤ªä¸“ä¸šçš„\nåˆ«äººå¬ä¸æ‡‚å°±æ˜¯å°´å°¬ï¼Œè¦ç”¨é€šä¿—çš„è¯­è¨€ã€‚", "[äºŒR] é¿å¼€å¤ªç§å¯†çš„\nå®¶ä¸‘ä¸å¯å¤–æ‰¬ï¼Œèšä¼šå›¾ä¸ªå¼€å¿ƒã€‚", "[ä¸‰R] é¿å¼€å¤ªæ²‰é‡çš„\nåˆ«èŠç”Ÿè€ç—…æ­»ï¼ŒèŠç‚¹è½»æ¾æ„‰å¿«çš„ã€‚"] },
                { intro: "æœ‰äº›äººå¤©ç”Ÿå°±æ‡‚ç¤¾äº¤å—ï¼Ÿä¸ï¼Œä»–ä»¬åªæ˜¯æ—©å­¦ä¼šäº†çœ‹çœ¼è‰²ã€‚", points: ["[ä¸€R] å­¦ä¼šçœ‹çœ¼è‰²\nå¯¹æ–¹ä¸æƒ³èŠäº†ï¼Œå°±åŠæ—¶æ‰“ä½ã€‚", "[äºŒR] å­¦ä¼šç»™é¢å­\nåˆ«äººå‡ºä¸‘å¸®ç€åœ†åœºï¼Œåˆ«è·Ÿç€èµ·å“„ã€‚", "[ä¸‰R] å­¦ä¼šæ¢ä½æ€è€ƒ\nè¯´è¯å‰è¿‡è¿‡è„‘å­ï¼Œè¿™å°±å«æƒ…å•†ã€‚"] }
            ],
            'relationship': [
                { intro: "ä¸ºä»€ä¹ˆä½ æ€»æ˜¯è¢«å ä¾¿å®œï¼Ÿä¸æ˜¯ä½ å¤ªå–„è‰¯ï¼Œè€Œæ˜¯ä¸æ‡‚è®¾ç«‹è¾¹ç•Œã€‚", points: ["[ä¸€R] ç¬¬ä¸€æ¬¡å°±è¦è¯´ä¸\nå€Ÿç±³ä¸è¿˜ï¼Œç¬¬ä¸€æ¬¡å°±è¦æ˜ç¡®æ€åº¦ã€‚", "[äºŒR] ä¸è¦ç”¨åˆ«äººçš„æ ‡å‡†è¦æ±‚è‡ªå·±\nåˆ«äººè¯´ä½ å°æ°”ï¼Œé‚£æ˜¯ä»–çš„æ ‡å‡†ï¼Œä½ æ²¡åšé”™ã€‚", "[ä¸‰R] è¿œç¦»æƒ…æ„Ÿå¸è¡€é¬¼\nåªç´¢å–ä¸ä»˜å‡ºçš„äººï¼Œè¶æ—©è¿œç¦»ã€‚"] },
                { intro: "å¦‚ä½•å§”å©‰æ‹’ç»ä¸æƒ³åšçš„äº‹ï¼Ÿè¿™ä¸‰ä¸ªæ–¹å¼è®©ä½ ä¸å¾—ç½ªäººã€‚", points: ["[ä¸€R] å¼ºè°ƒå®¢è§‚åŸå› \nè¯´è‡ªå·±çœŸçš„å¾ˆå¿™ï¼Œæ‰‹ä¸Šæœ‰æ€¥äº‹ã€‚", "[äºŒR] æä¾›æ›¿ä»£æ–¹æ¡ˆ\nè™½ç„¶æˆ‘å¸®ä¸äº†ï¼Œä½†æˆ‘å¯ä»¥å¸®ä½ é—®é—®åˆ«äººã€‚", "[ä¸‰R] è¡¨è¾¾ç†è§£\næˆ‘çŸ¥é“ä½ ç€æ€¥ï¼Œä½†æˆ‘çœŸçš„æœ‰å¿ƒæ— åŠ›ã€‚"] },
                { intro: "æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªäººå€¼ä¸å€¼å¾—æ·±äº¤ï¼Ÿè§‚å¯Ÿè¿™ä¸‰ä¸ªç»†èŠ‚ã€‚", points: ["[ä¸€R] çœ‹ä»–å¯¹æœåŠ¡å‘˜çš„æ€åº¦\nå¯¹ä¸‹åˆ»è–„çš„äººï¼Œäººå“å¤šåŠä¸è¡Œã€‚", "[äºŒR] çœ‹ä»–ä¼šä¸ä¼šå®ˆæ—¶\nç»å¸¸è¿Ÿåˆ°è¯´æ˜ä¸å°Šé‡åˆ«äººçš„æ—¶é—´ã€‚", "[ä¸‰R] çœ‹ä»–å€Ÿç±³åçš„è¡¨ç°\næ¬ ç±³ä¸è¿˜çš„äººï¼Œç›´æ¥æ‹‰é»‘ã€‚"] },
                { intro: "ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œæ··å¾—å¥½çš„äººéƒ½ä¼šå€ŸåŠ›ã€‚ä¸æ˜¯é å•æ‰“ç‹¬æ–—ã€‚", points: ["[ä¸€R] æ‡‚å¾—éº»çƒ¦åˆ«äºº\né€‚å½“çš„éº»çƒ¦æ˜¯å»ºç«‹å…³ç³»çš„å¼€å§‹ã€‚", "[äºŒR] ä¸»åŠ¨åˆ›é€ æœºä¼š\nåˆ«ç­‰åˆ«äººæ‰¾ä½ ï¼Œä¸»åŠ¨å»é“¾æ¥èµ„æºã€‚", "[ä¸‰R] ç»´æŠ¤é•¿æœŸå…³ç³»\nåˆ«ç”¨äººæœå‰ä¸ç”¨äººæœåï¼Œå¹³æ—¶å¤šè”ç³»ã€‚"] },
                { intro: "å¦‚ä½•é¿å…æˆä¸ºç¤¾äº¤å·¥å…·äººï¼Ÿå­¦ä¼šè¿™ä¸‰æ‹›ä¿æŠ¤è‡ªå·±ã€‚", points: ["[ä¸€R] è¯†åˆ«çœŸå‡æœ‹å‹\nå¹³æ—¶ä¸è”ç³»æœ‰äº‹æ‰æ‰¾ä½ çš„ï¼Œå¤šåŠæ˜¯å·¥å…·ã€‚", "[äºŒR] å­¦ä¼šæœ‰æ¡ä»¶çš„å¸®å¿™\näº’æƒ äº’åˆ©æ‰æ˜¯å¥åº·çš„å…³ç³»ã€‚", "[ä¸‰R] æœæ–­æ‹’ç»æ— ç†è¦æ±‚\nè¶…å‡ºåº•çº¿çš„è¦æ±‚ï¼Œç›´æ¥æ‹’ç»åˆ«çŠ¹è±«ã€‚"] },
                { intro: "ä¸ºä»€ä¹ˆä½ çš„äººè„‰éƒ½æ˜¯æ— æ•ˆäººè„‰ï¼Ÿå› ä¸ºä½ åªçŸ¥é“åŠ å¥½å‹ï¼Œä¸çŸ¥é“ç»´æŠ¤å…³ç³»ã€‚", points: ["[ä¸€R] åªåŠ ä¸èŠ\nå‚åŠ æ´»åŠ¨åŠ äº†ä¸€å †å¥½å‹ï¼ŒåŠ å®Œå°±ä¸è”ç³»äº†ã€‚è¿‡å‡ ä¸ªæœˆå¯¹æ–¹è¿ä½ æ˜¯è°éƒ½ä¸è®°å¾—ã€‚", "[äºŒR] åªç´¢å–ä¸ä»˜å‡º\néœ€è¦å¸®å¿™æ‰æƒ³èµ·å¯¹æ–¹ï¼Œå¹³æ—¶ä»ä¸ä¸»åŠ¨åˆ†äº«æœ‰ç”¨çš„ä¿¡æ¯ã€‚", "[ä¸‰R] ä¸æ‡‚å¾—ç»è¥\næœ‰äº†æ–°å·¥åšã€æ–°è”ç³»æ–¹å¼ï¼Œä¸ä¸»åŠ¨å‘Šè¯‰æœ‹å‹ã€‚"] }
            ],
            'mindset': [
                { intro: "ç¤¾äº¤ç„¦è™‘çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿä¸æ˜¯å®³æ€•äººå¤šï¼Œè€Œæ˜¯å®³æ€•è¢«è¯„ä»·ã€‚", points: ["[ä¸€R] å®³æ€•è¢«è¯„ä»·\nå…¶å®å¤§å®¶éƒ½å¾ˆå¿™ï¼Œæ²¡ç©ºç›¯ç€ä½ ã€‚", "[äºŒR] å®³æ€•è¢«æ‹’ç»\næ‹’ç»æ˜¯å¸¸æ€ï¼Œä¸ä»£è¡¨ä½ ä¸å¥½ã€‚", "[ä¸‰R] å®³æ€•è¢«çœ‹ç©¿\næ¥å—è‡ªå·±çš„ä¸å®Œç¾ï¼ŒçœŸå®æ‰åŠ¨äººã€‚"] },
                { intro: "ä¸æ˜¯ä½ é•¿ä¸å¤§ï¼Œæ˜¯ä½ å®¶ä¸å…è®¸ä½ é•¿å¤§ã€‚æ ¹æºåœ¨åŸç”Ÿå®¶åº­ã€‚", points: ["[ä¸€R] æ²¡è§è¿‡çˆ¶æ¯ç¤¾äº¤\nä»å°æ²¡æ¦œæ ·ï¼Œé•¿å¤§äº†è‡ªç„¶ä¸ä¼šã€‚", "[äºŒR] å®¶é‡Œä¸è®©è¯•é”™\næ€•çŠ¯é”™æ‰€ä»¥ä¸æ•¢åŠ¨ï¼Œç¤¾äº¤èƒ½åŠ›å°±é€€åŒ–äº†ã€‚", "[ä¸‰R] ç¼ºå°‘æƒ…æ„Ÿå›åº”\nä¸æ‡‚è¡¨è¾¾æ„Ÿæƒ…ï¼Œè¿å…³å¿ƒäººéƒ½è§‰å¾—å°´å°¬ã€‚"] },
                { intro: "æˆ‘æ›¾ç»ä¹Ÿæ˜¯ç¤¾æï¼Œåæ¥æ‰æ˜ç™½ï¼šç¤¾äº¤æ˜¯ä¸€ç§å¯ä»¥ä¹ å¾—çš„èƒ½åŠ›ã€‚", points: ["1ã€ä»è®°ä½åå­—å¼€å§‹\nå¼ºè¿«è‡ªå·±è®°ä½å¯¹æ–¹åå­—ï¼Œä¸‹æ¬¡å«å‡ºæ¥ã€‚", "2ã€ä¸»åŠ¨åˆ¶é€ è¯é¢˜\nåˆ«ç­‰åˆ«äººé—®ï¼Œè‡ªå·±å…ˆå¼€å£ã€‚", "3ã€æ˜ç™½äº†ä¸è®¨å¥½\nåšè‡ªå·±ï¼Œè‡ªç„¶ä¼šå¸å¼•åŒé¢‘çš„äººã€‚"] },
                { intro: "ä¸ºä»€ä¹ˆæœ‰äº›äººæ˜æ˜å¾ˆä¼˜ç§€ï¼Œå´æ²¡æœ‰å¥½äººç¼˜ï¼Ÿ", points: ["[ä¸€R] è¿‡åº¦å±•ç¤ºä¼˜è¶Šæ„Ÿ\næ²¡äººå–œæ¬¢å¬ä½ ç‚«è€€ã€‚", "[äºŒR] ä¸ç»™åˆ«äººæœºä¼š\nè¯éƒ½è®©ä½ è¯´äº†ï¼Œåˆ«äººè¯´ä»€ä¹ˆï¼Ÿ", "[ä¸‰R] åªæŒ‘æ¯›ç—…\næ€»æ˜¯å¦å®šåˆ«äººï¼Œè°æ„¿æ„è·Ÿä½ ç©ï¼Ÿ"] },
                { intro: "ç¤¾äº¤ä¸­æœ€é«˜çº§çš„èƒ½åŠ›ï¼Œä¸æ˜¯èƒ½è¯´ä¼šé“ï¼Œè€Œæ˜¯è®©äººèˆ’æœã€‚", points: ["[ä¸€R] ä¸å°¬èŠ\næ²¡è¯æ‰¾è¯æœ€ç´¯äººï¼Œä¸å¦‚å®‰é™ä¸€ä¼šã€‚", "[äºŒR] ä¸è¯„ä»·\nå°Šé‡åˆ«äººçš„ç”Ÿæ´»æ–¹å¼ï¼Œåˆ«æŒ‡æ‰‹ç”»è„šã€‚", "[ä¸‰R] ä¸æ¯”è¾ƒ\nå„äººæœ‰å„äººçš„æ´»æ³•ï¼Œåˆ«æ€»æƒ³ç€å‹äººä¸€å¤´ã€‚"] },
                { intro: "ä¸ºä»€ä¹ˆä½ æ€»æ˜¯åœ¨ç¤¾äº¤ä¸­åƒäºï¼Ÿå› ä¸ºä½ ä¸æ‡‚è¿™ä¸‰ä¸ªé˜²å®ˆåŸåˆ™ã€‚", points: ["[ä¸€R] ä¸è¦è½»æ˜“æ‰¿è¯º\nåˆ«äººæè¦æ±‚ï¼Œä¸è¦æƒ³éƒ½ä¸æƒ³å°±ç­”åº”ã€‚", "[äºŒR] ä¸è¦è¿‡åº¦è‡ªæˆ‘ç‰ºç‰²\nå¸®å¿™å¯ä»¥ï¼Œä½†ä¸èƒ½æ¬¡æ¬¡éƒ½æ˜¯ä½ åƒäºã€‚", "[ä¸‰R] ä¸è¦æ€•å¾—ç½ªäºº\næœ‰äº›äº‹è¯¥æ‹’ç»å°±æ‹’ç»ï¼Œè¯¥è¯´ä¸å°±è¯´ä¸ã€‚"] }
            ]
        };

        const FIXED_TEMPLATE = {
            intro: `å¾ˆå¤šiäººå®å®éƒ½é¢ä¸´ç€ç¤¾äº¤æ–¹é¢çš„å›°æ‰°ï¼Œå› ä¸ºæ›¾ç»æˆ‘ä¹Ÿæ˜¯ä¸€ä¸ªå†…å‘ã€æ•æ„Ÿçš„äººï¼Œä¸å–„æ²Ÿé€šï¼Œä¸ä¼šå¤„äº‹ã€‚`,
            change: `æ‰€ä»¥ï¼Œæˆ‘èŠ±äº†å››å¹´æ—¶é—´ï¼Œæ…¢æ…¢æ”¹å˜è‡ªå·±ï¼Œç°åœ¨æˆ‘å°†æˆ‘çš„ç»éªŒæ€»ç»“æˆäº†ä¸€ä»½20ä¸‡å­—ï¼Œå…±67èŠ‚å†…å®¹çš„ç¤¾ä¼šåŒ–æ”»ç•¥æŒ‡å—ã€‚`,
            hope: `å¸Œæœ›ä½ ä¹Ÿèƒ½å’Œæˆ‘ä¸€æ ·ï¼Œä»å†…å‘æ•æ„Ÿå˜æˆè½è½å¤§æ–¹ï¼Œå°‘èµ°å‡ å¹´å¼¯è·¯ï¼Œæ‡‚å¾—ä¸ºäººå¤„äº‹çš„æ–¹æ³•ã€‚`,
            highlights: `è¿™ä»½æ‰‹å†Œçš„äº®ç‚¹ï¼š\n1ï¸âƒ£ å…¨æ–‡20ä¸‡å­—ï¼Œ67èŠ‚å†…å®¹ï¼Œä¸æºæ°´çº¯å¹²è´§ï¼Œåªè®²æœ€æœ‰ç”¨çš„æ–¹æ³•ï¼Œä¸è®²ç©ºè¯ã€‚\n2ï¸âƒ£ æ¶µç›–å„ç§åœºåˆï¼Œå€¼åœºã€èšä¼šã€é¥­å±€ç­‰ç­‰ï¼Œå¸¦ä½ è½»æ¾åº”å¯¹æ‰€æœ‰ç¤¾äº¤éš¾é¢˜ã€‚\n3ï¸âƒ£ æ€»ç»“ä¸‡èƒ½å¯¹è¯å…¬å¼å’Œå„åœºæ™¯å¯¹è¯æ¡ˆä¾‹ï¼Œé‚¦åŠ©å¿«é€Ÿç†è§£å’Œå­¦ä¹ ã€‚\n4ï¸âƒ£ èµ é€ç¤¾ä¼šåŒ–æ€ç»´å¯¼å›¾ã€ç”µå­ä¹¦ç­‰ï¼ˆç”µå­ç‰ˆï¼‰`,
            audience: `è¿™ä»½æ‰‹å†Œé€‚åˆè°ç”¨ï¼Ÿ\n1ï¸âƒ£ å†…å‘è€…/ç¤¾æï¼šå®³æ€•ä¸»åŠ¨ç¤¾äº¤ï¼Œæƒ³æ‘†è„±ç´§å¼ å’Œå°´å°¬\n2ï¸âƒ£ å€¼åœºæ–°äººï¼šä¸æ‡‚å€¼åœºè§„åˆ™ï¼Œæƒ³è¦æ™‹å‡å´ä¸æ‡‚å‘ä¸Šç®¡ç†\n3ï¸âƒ£ æ²Ÿé€šå°ç™½ï¼šè¯´è¯ç›´æ¥ç›´å»ï¼Œå¸¸è¢«è¯¯ä¼šï¼Œæƒ³å˜å¥½è¡¨è¾¾æ–¹å¼\n4ï¸âƒ£ æ•æ„Ÿå‹äººæ ¼ï¼šè¿‡åº¦åœ¨æ„ä»–äººçœ‹æ³•ï¼Œå®¹æ˜“å†…è€—ï¼Œæƒ³å­¦ä¼šè‡ªæˆ‘è°ƒèŠ‚\n5ï¸âƒ£ è€å®äººï¼šä¸ä¼šæ‹’ç»ï¼Œæ€»è¢«å ä¾¿å®œï¼Œæƒ³å­¦ä¼šä¿æŠ¤è‡ªå·±\n6ï¸âƒ£ æƒ³å˜å¥½å½±å“åŠ›çš„äººï¼šå¸Œæœ›å»ºç«‹é«˜è´¨é‡äººè„‰ï¼Œå‘ä¸Šç¤¾äº¤`,
            cta: `â—ï¸â—ï¸éœ€è¦çš„å¯ä»¥å‰å¾€ä¸»é¡µåº—é“ºé¢†å– ğŸ›’ğŸ›’ğŸ›’`
        };

        // âš ï¸ æ•æ„Ÿè¯åº“åŠ å¼ºç‰ˆ (å¾®ä¿¡ -> å¹³æ—¶èŠå¤©)
        const SENSITIVE_WORDS = { 
            'åŠ å¾®ä¿¡': 'åŠ å¥½å‹', 'å¾®ä¿¡': 'å¹³æ—¶èŠå¤©', 'é’±': 'ç±³', 'èµšé’±': 'æç±³', 'ç§ä¿¡': 'åå°', 
            'æŠ€å·§': 'æ–¹æ³•', 'æŠ€èƒ½': 'æ–¹å¼', 'å¸®åŠ©': 'é‚¦åŠ©', 'å·¥ä½œ': 'å·¥åš', 
            'èŒåœº': 'å€¼åœº', 'å…¬å¸': 'å…¬åŒ', 'å•ä½': 'å–®ä½', 'åŒäº‹': 'åŒå£«',
            'è¥é”€': 'è¥æ¶ˆ', 'å¼•æµ': 'å¯¼æµ'
        };
        
        // âš ï¸ çœŸå®çƒ­æœè¯åº“
        const XHS_REAL_KEYWORDS = {
            'social': ['ç¤¾ä¼šåŒ–', 'ç¤¾ä¼šåŒ–ç¨‹åº¦ä½', 'ç¤¾ä¼šåŒ–æŒ‡å—', 'ç¤¾ä¼šåŒ–ç¨‹åº¦é«˜çš„äºº', 'æè¯è¯´å¥³ç”Ÿå°½æ—©å®Œæˆç¤¾ä¼šåŒ–', 'æå‡ç¤¾ä¼šåŒ–', 'æˆå¹´äººç¤¾ä¼šåŒ–', 'iäººç¤¾ä¼šåŒ–'],
            'work': ['èŒåœº', 'èŒåœºç”Ÿå­˜æ³•åˆ™', 'èŒåœºéœ¸å‡Œ', 'åˆå…¥èŒåœº', 'èŒåœºå¹²è´§', 'èŒåœºæ€ç»´', 'èŒåœºäººé™…å…³ç³»', '00åæ•´é¡¿èŒåœº', 'èŒåœºé‚£äº›äº‹', 'èŒåœºæˆé•¿'],
            'growth': ['ä¸ªäººæˆé•¿', 'æˆé•¿', 'è‡ªæˆ‘æå‡', 'æˆé•¿ç¬”è®°', 'æˆé•¿æ„Ÿæ‚Ÿ', 'é€†è¢­', 'æ€ç»´æå‡', 'è®¤çŸ¥è§‰é†’', 'å¥³æ€§æˆé•¿', 'è‡ªå¾‹', 'æ¸…é†’'],
            'human': ['äººæƒ…ä¸–æ•…', 'èŒåœºäººæƒ…ä¸–æ•…', 'ä¸ºäººå¤„äº‹', 'æ¯å¤©æ‡‚ä¸€ç‚¹äººæƒ…ä¸–æ•…', 'ä¸­å›½å¼äººæƒ…ä¸–æ•…', 'ä¸æ‡‚äººæƒ…ä¸–æ•…', 'é«˜æƒ…å•†', 'æƒ…å•†']
        };

        // === 2. æ ¸å¿ƒé€»è¾‘ ===
        let lastIntro = ""; 

        function getRelevantContent(title) {
            let pool = [];
            if (title.match(/èŒåœº|å·¥ä½œ|é¢†å¯¼|è€æ¿|åŒäº‹|å‡èŒ|é¢è¯•|æ±‡æŠ¥|å…¬å¸|å•ä½/)) pool = CONTENT_LIBRARY['work'];
            else if (title.match(/èŠå¤©|æ¥è¯|å†·åœº|è¯é¢˜|è¯´è¯|æ²Ÿé€š|å›å¤|å¾®ä¿¡|ç ´å†°|å¼€å£/)) pool = CONTENT_LIBRARY['chat'];
            else if (title.match(/é¥­å±€|èšé¤|é…’|è¯·å®¢|ä¹°å•|ç¤¼ä»ª|åœºé¢|åº”é…¬/)) pool = CONTENT_LIBRARY['dinner'];
            else if (title.match(/æœ‹å‹|äººè„‰|æ‹’ç»|å¸®å¿™|å€Ÿé’±|äººæƒ…|åˆ©ç”¨|è®¨å¥½|å…³ç³»|å¥½äººç¼˜|æ·±äº¤/)) pool = CONTENT_LIBRARY['relationship'];
            else if (title.match(/ç¤¾æ|å†…å‘|ç„¦è™‘|å®¶åº­|æ•æ„Ÿ|å¿ƒæ€|iäºº|ç¤¾ä¼šåŒ–/)) pool = CONTENT_LIBRARY['mindset'];
            
            if (pool.length === 0) {
                pool = [
                    ...CONTENT_LIBRARY['work'], ...CONTENT_LIBRARY['chat'], 
                    ...CONTENT_LIBRARY['dinner'], ...CONTENT_LIBRARY['relationship'], 
                    ...CONTENT_LIBRARY['mindset']
                ];
            }

            let selected = randomPick(pool);
            let attempts = 0;
            while (selected.intro === lastIntro && attempts < 5) {
                selected = randomPick(pool);
                attempts++;
            }
            lastIntro = selected.intro;
            return selected;
        }

        function generateTags(title) {
            let tags = [];
            tags.push('#æ™®é€šäººç¤¾ä¼šåŒ–æŒ‡å—', '#äººæƒ…ä¸–æ•…'); 
            
            if(title.match(/èŒåœº|å·¥ä½œ|é¢†å¯¼|åŒäº‹/)) tags.push(...randomPickMultiple(XHS_REAL_KEYWORDS['work'], 3).map(t=>'#'+t));
            else if(title.match(/ç¤¾äº¤|æœ‹å‹|äººè„‰|åœˆå­/)) tags.push(...randomPickMultiple(XHS_REAL_KEYWORDS['human'], 3).map(t=>'#'+t));
            else if(title.match(/æ‹’ç»|è€å¥½äºº|å¸®å¿™/)) tags.push('#å­¦ä¼šæ‹’ç»', '#é«˜æƒ…å•†', '#æ‹’ç»å†…è€—');
            else if(title.match(/èŠå¤©|æ¥è¯|è¯´è¯|æ²Ÿé€š/)) tags.push('#é«˜æƒ…å•†èŠå¤©', '#æ²Ÿé€šæŠ€å·§', '#ä¼šè¯´è¯');
            else if(title.match(/é¥­å±€|èšé¤|åº”é…¬/)) tags.push('#é¥­å±€æ–‡åŒ–', '#é¥­å±€', '#åº”é…¬');
            else tags.push(...randomPickMultiple(XHS_REAL_KEYWORDS['social'], 3).map(t=>'#'+t));
            
            const pool = [...XHS_REAL_KEYWORDS['growth'], ...XHS_REAL_KEYWORDS['human'], 'ç”Ÿæ´»æ™ºæ…§', 'å¹²è´§åˆ†äº«', 'ç»éªŒæ€»ç»“'];
            
            let attempts = 0;
            while(tags.length < 10 && attempts < 100) {
                const word = pool[Math.floor(Math.random() * pool.length)];
                const tag = '#' + word;
                if(!tags.includes(tag)) {
                    tags.push(tag);
                }
                attempts++;
            }
            
            return tags.slice(0, 10).join(' ');
        }

        function randomPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function randomPickMultiple(array, count) { return array.sort(() => 0.5 - Math.random()).slice(0, count); }
        function filterSensitive(text) {
            let res = text;
            for(let key in SENSITIVE_WORDS) res = res.replace(new RegExp(key, 'g'), SENSITIVE_WORDS[key]);
            return res;
        }

        function generateOne(title) {
            const premium = getRelevantContent(title);
            const includeHope = Math.random() > 0.3;
            
            let content = premium.intro + "\n\n";
            content += premium.points.join("\n\n") + "\n\n";
            content += FIXED_TEMPLATE.intro + "\n\n";
            content += FIXED_TEMPLATE.change + "\n\n";
            if (includeHope) content += FIXED_TEMPLATE.hope + "\n\n";
            content += FIXED_TEMPLATE.highlights + "\n\n";
            content += FIXED_TEMPLATE.audience + "\n\n";
            content += FIXED_TEMPLATE.cta;
            
            content = filterSensitive(content);
            const tags = generateTags(title);
            
            return { content: content, tags: tags };
        }

        // === 3. ç•Œé¢äº¤äº’ ===
        let assignData = null, excelData = null, isPaused = false, currentIndex = 0;

        function showHelp() { document.getElementById('mainPage').classList.add('hidden'); }
        function showMain() { document.getElementById('mainPage').classList.remove('hidden'); }

        function activate() {
            const code = document.getElementById('activationCode').value.trim();
            if (code.startsWith('XHS-')) {
                localStorage.setItem('activation', JSON.stringify({ code, business: 'æ»¡é…å®‰å…¨ç‰ˆ', expireDate: '2026-12-31' }));
                showStatus('activationStatus', 'âœ… æ¿€æ´»æˆåŠŸ', 'success');
                setTimeout(() => location.reload(), 1000);
            } else showStatus('activationStatus', 'âŒ æ¿€æ´»ç æ— æ•ˆ', 'error');
        }
        function resetActivation() { localStorage.removeItem('activation'); location.reload(); }

        function downloadBlankTemplate() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['æ ‡é¢˜']]), "ç©ºç™½æ¨¡æ¿");
            XLSX.writeFile(wb, 'æ­¥éª¤1_ç©ºç™½æ¨¡æ¿.xlsx');
        }

        function handleAssignFile() {
            const f = document.getElementById('assignFile').files[0];
            if(!f) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                assignData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                showStatus('assignFileInfo', `âœ… å·²åŠ è½½ ${assignData.length} æ¡`, 'success');
                document.getElementById('assignProgress').classList.remove('hidden');
                await startAssignment();
            };
            reader.readAsArrayBuffer(f);
        }

        async function startAssignment() {
            const log = document.getElementById('assignLog'); log.innerHTML = '';
            const results = [];
            const templates = ['æ¨¡æ¿1', 'æ¨¡æ¿3'];
            const topics = ['æ‹©è¨€', 'äººæƒ…ä¸–æ•…', 'ç¤¾äº¤æ™ºæ…§', 'ç©å¡æ”»', 'é˜²éª—è¯', 'é€‚ç”¨'];
            
            for (let i = 0; i < assignData.length; i++) {
                const title = assignData[i]['æ ‡é¢˜'] || '';
                results.push({ 'åºå·': i+1, 'æ¨¡æ¿ç±»å‹': randomPick(templates), 'æ ‡é¢˜': title, 'é€‰é¢˜': randomPick(topics), 'ç”Ÿæˆæ•°é‡': 1 });
                document.getElementById('assignProgressFill').style.width = ((i+1)/assignData.length*100)+'%';
                log.innerHTML += `<div class="log-item">âœ“ åˆ†é…: ${title.substring(0,10)}...</div>`;
                log.scrollTop = log.scrollHeight;
                await new Promise(r => setTimeout(r, 10));
            }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(results), "åˆ†é…ç»“æœ");
            XLSX.writeFile(wb, `åˆ†é…ç»“æœ_${Date.now()}.xlsx`);
            log.innerHTML += `<div class="log-item success">âœ… åˆ†é…å®Œæˆï¼</div>`;
        }

        function handleFileSelect() {
            const f = document.getElementById('excelFile').files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (excelData[0] && excelData[0]['æ ‡é¢˜']) {
                    showStatus('fileInfo', `âœ… å°±ç»ª | ${excelData.length} æ¡`, 'success');
                    document.getElementById('generateBtn').disabled = false;
                }
            };
            reader.readAsArrayBuffer(f);
        }

        async function startGeneration() {
            if (!excelData) return;
            isPaused = false;
            document.getElementById('generateBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            const log = document.getElementById('log'); log.innerHTML = '';
            
            const results = [];
            const validData = excelData.filter(r => r['æ ‡é¢˜']);
            
            for (let i = currentIndex; i < validData.length; i++) {
                if (isPaused) { currentIndex = i; return; }
                const row = validData[i];
                const count = parseInt(row['ç”Ÿæˆæ•°é‡']) || 1;
                
                log.innerHTML += `<div class="log-item">[${i+1}/${validData.length}] æ­£åœ¨ç”Ÿæˆ: ${row['æ ‡é¢˜'].substring(0,10)}...</div>`;
                log.scrollTop = log.scrollHeight;
                
                for (let j = 0; j < count; j++) {
                    const generated = generateOne(row['æ ‡é¢˜']);
                    results.push({ 
                        'åºå·': results.length+1, 
                        'æ ‡é¢˜': row['æ ‡é¢˜'], 
                        'æ–‡æ¡ˆ': generated.content, 
                        'è¯é¢˜': generated.tags,
                        'å­—æ•°': generated.content.length 
                    });
                }
                
                document.getElementById('progressFill').style.width = ((i+1)/validData.length*100)+'%';
                document.getElementById('progressFill').textContent = Math.round(((i+1)/validData.length*100))+'%';
                await new Promise(r => setTimeout(r, 20));
            }
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(results), "ç”Ÿæˆç»“æœ");
            XLSX.writeFile(wb, `å®‰å…¨æ–‡æ¡ˆ_${Date.now()}.xlsx`);
            
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('generateBtn').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = false;
            log.innerHTML += `<div class="log-item success">âœ… å…¨éƒ¨å®Œæˆï¼å·²è‡ªåŠ¨ä¸‹è½½</div>`;
        }

        function pauseGeneration() { isPaused = true; document.getElementById('pauseBtn').classList.add('hidden'); document.getElementById('resumeBtn').classList.remove('hidden'); }
        function resumeGeneration() { isPaused = false; document.getElementById('resumeBtn').classList.add('hidden'); document.getElementById('pauseBtn').classList.remove('hidden'); startGeneration(); }
        
        function showStatus(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `status ${type}`; el.classList.remove('hidden'); }

        window.onload = function() {
            const activation = localStorage.getItem('activation');
            if (activation) {
                const info = JSON.parse(activation);
                document.getElementById('activationSection').classList.add('hidden');
                document.getElementById('activatedInfo').classList.remove('hidden');
                document.getElementById('assignSection').classList.remove('hidden');
                document.getElementById('generateSection').classList.remove('hidden');
                document.getElementById('businessInfo').textContent = 'v3.7 æè‡´å®‰å…¨ç‰ˆ';
                document.getElementById('expireInfo').textContent = info.expireDate;
            }
        };
    </script>
</body>
</html>